<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MediaBuddy - Установка нового пароля</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    /* Общие стили (как описано выше) */
    body { background-color: #141414; color: #ffffff; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
    .form-container { max-width: 450px; width: 100%; padding: 40px; background-color: rgba(0, 0, 0, 0.80); border-radius: 4px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.7); }
    .logo { text-align: center; margin-bottom: 30px; font-size: 2.5rem; font-weight: bold; color: #e50914; }
    .form-title { color: #fff; font-weight: 500; margin-bottom: 20px; text-align: center; }
    .form-control { background-color: #333; border: 1px solid #333; color: #fff; height: 50px; margin-bottom: 20px; border-radius: 4px; }
    .form-control:focus { background-color: #454545; color: #fff; box-shadow: 0 0 0 0.2rem rgba(229, 9, 20, 0.25); border-color: #555; }
    .form-control::placeholder { color: #8c8c8c; }
    .btn-custom { background-color: #e50914; color: white; border: none; height: 50px; font-weight: bold; font-size: 1rem; border-radius: 4px; width: 100%; margin-top: 10px; }
    .btn-custom:hover, .btn-custom:focus { background-color: #f40612; color: white; }
    .error-message { background-color: rgba(229, 9, 20, 0.1); border-left: 4px solid #e50914; padding: 12px; margin-top: 15px; margin-bottom: 15px; color: #fff; font-size: 0.9rem; border-radius: 0 4px 4px 0; display: none; }
    .input-group-text { background-color: #333; border: 1px solid #333; color: #8c8c8c; }
    .input-group .bi { color: #8c8c8c; }
    .form-text a { color: #b3b3b3; text-decoration: none; }
    .form-text a:hover { text-decoration: underline; color: #fff;}
  </style>
</head>
<body>
<div class="form-container">
  <div class="logo">MediaBuddy</div>
  <h2 class="form-title">Установить новый пароль</h2>

  <form id="reset-password-form">
    <div class="mb-3">
      <label for="email" class="form-label">Email</label>
      <input type="email" class="form-control" id="email" readonly>
    </div>

    <div class="mb-3">
      <label for="code" class="form-label">Код из письма</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-shield-lock-fill"></i></span>
        <input type="text" class="form-control" id="code" placeholder="Код подтверждения" required>
      </div>
    </div>

    <div class="mb-3">
      <label for="password" class="form-label">Новый пароль</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
        <input type="password" class="form-control" id="password" placeholder="Новый пароль" required>
      </div>
      <div class="form-text" style="font-size: 0.8rem; color: #b3b3b3; margin-top: 5px;">Пароль должен содержать минимум 8 символов, включая цифру, строчную и заглавную буквы, и спецсимвол.</div>
    </div>

    <div class="mb-3">
      <label for="confirm-password" class="form-label">Подтвердите пароль</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
        <input type="password" class="form-control" id="confirm-password" placeholder="Подтвердите пароль" required>
      </div>
    </div>

    <button type="submit" class="btn btn-custom w-100">Сбросить пароль</button>

    <div id="error-message" class="error-message mt-3"></div>
    <div id="success-message" class="alert alert-success mt-3" style="display: none;"></div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const urlParams = new URLSearchParams(window.location.search);
    const emailFromQuery = urlParams.get('email');
    const emailField = document.getElementById("email");
    const form = document.getElementById('reset-password-form'); // Получаем форму
    const submitButton = form.querySelector('button[type="submit"]'); // Кнопка внутри формы
    const errorMessageElementOnLoad = document.getElementById("error-message"); // Для ошибок при загрузке

    if (emailFromQuery) {
      emailField.value = decodeURIComponent(emailFromQuery);
    } else {
      emailField.value = ""; // Оставляем пустым или можно написать "Email не найден"
      if (errorMessageElementOnLoad) {
        errorMessageElementOnLoad.textContent = "Ошибка: Email не был передан на эту страницу. Пожалуйста, начните процесс сброса сначала.";
        errorMessageElementOnLoad.style.display = "block";
      }
      if(submitButton) submitButton.disabled = true; // Блокируем кнопку, если нет email
    }
  });

  document.getElementById("reset-password-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    // Получаем элементы внутри обработчика submit
    const email = document.getElementById("email").value;
    const code = document.getElementById("code").value;
    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirm-password").value;
    const errorMessageElement = document.getElementById("error-message");
    const successMessageElement = document.getElementById("success-message");
    const submitButton = this.querySelector('button[type="submit"]'); // 'this' ссылается на форму

    errorMessageElement.style.display = "none";
    errorMessageElement.textContent = "";
    successMessageElement.style.display = "none";
    successMessageElement.textContent = "";
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Обновление...';

    if (!email) { // Дополнительная проверка, хотя email должен быть из URL
      errorMessageElement.textContent = "Email отсутствует. Пожалуйста, начните процесс сброса пароля заново.";
      errorMessageElement.style.display = "block";
      submitButton.disabled = false;
      submitButton.innerHTML = 'Сбросить пароль';
      return;
    }

    if (!code) {
      errorMessageElement.textContent = "Код сброса обязателен.";
      errorMessageElement.style.display = "block";
      submitButton.disabled = false;
      submitButton.innerHTML = 'Сбросить пароль';
      return;
    }

    if (password !== confirmPassword) {
      errorMessageElement.textContent = "Пароли не совпадают.";
      errorMessageElement.style.display = "block";
      submitButton.disabled = false;
      submitButton.innerHTML = 'Сбросить пароль';
      return;
    }

    const passwordPattern = /^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@#$%^&+=!])(?=\S+$).{8,30}$/;
    if (!passwordPattern.test(password)) {
      errorMessageElement.textContent = "Пароль не соответствует требованиям: минимум 8 символов, 1 цифра, 1 строчная, 1 заглавная буква, 1 спецсимвол (@#$%^&+=!). Длина от 8 до 30 символов.";
      errorMessageElement.style.display = "block";
      submitButton.disabled = false;
      submitButton.innerHTML = 'Сбросить пароль';
      return;
    }

    const resetData = {
      code: code, // Соответствует ResetPassDTO.code
      email: email,
      password: password,
      passwordConfirm: confirmPassword // Соответствует ResetPassDTO.passwordConfirm
    };

    try {
      // ИСПРАВЛЕННЫЙ URL для fetch
      const response = await fetch("/api/auth/reset-password", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(resetData),
      });

      if (response.ok) {
        successMessageElement.textContent = "Пароль успешно сброшен! Перенаправление на страницу входа...";
        successMessageElement.style.display = "block";
        setTimeout(() => {
          // ИСПРАВЛЕННЫЙ URL для редиректа
          window.location.href = "/authfront/login";
        }, 2500);
      } else {
        let errorText = "Ошибка при сбросе пароля."; // Сообщение по умолчанию
        try {
          // Пытаемся получить более детальное сообщение об ошибке от сервера
          const errorData = await response.json(); // Если сервер возвращает JSON
          if (errorData && typeof errorData === 'object' && errorData.message) {
            errorText = errorData.message;
          } else if (errorData && typeof errorData === 'string') { // Если сервер возвращает просто строку в JSON
            errorText = errorData;
          } else if (errorData && Array.isArray(errorData.errors)) { // Если Spring Validation возвращает массив ошибок
            errorText = errorData.errors.map(err => err.defaultMessage || err).join(', ');
          } else {
            const textResponse = await response.text(); // Если не JSON, пробуем как текст
            if (textResponse) errorText = textResponse;
          }
        } catch (e) {
          // Если парсинг JSON или text() не удался, используем статус
          errorText = `Ошибка ${response.status}: ${response.statusText || "Не удалось обработать ответ сервера."}`;
        }
        errorMessageElement.textContent = errorText;
        errorMessageElement.style.display = "block";
        submitButton.disabled = false;
        submitButton.innerHTML = 'Сбросить пароль';
      }
    } catch (error) {
      console.error("Ошибка сети при сбросе пароля:", error);
      errorMessageElement.textContent = "Ошибка сети или сервера. Пожалуйста, попробуйте позже.";
      errorMessageElement.style.display = "block";
      submitButton.disabled = false;
      submitButton.innerHTML = 'Сбросить пароль';
    }
  });
</script>
</body>
</html>